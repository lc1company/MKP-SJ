<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard do Motorista</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Roboto:wght@300;400;700&display=swap');

        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f5f5f5;
            margin: 0 auto;
            padding: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            max-width: 920px;
            color: #333;
        }

        .container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .bottom-nav {
            width: 100%;
            display: flex;
            justify-content: space-around;
            background-color: #222;
            padding: 15px 0;
            position: fixed;
            bottom: 0;
        }

        .bottom-nav button {
            background: none;
            border: none;
            color: white;
            font-size: 16px;
            cursor: pointer;
            transition: color 0.3s;
        }

        .bottom-nav button:hover {
            color: #007bff;
        }

        #driverDashboard {
            padding: 20px;
            background-color: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        #driverDashboard .map-container {
            width: 100%;
            height: 300px;
            margin-bottom: 20px;
        }

        #driverDashboard button {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }

        #driverDashboard button:hover {
            background-color: #0056b3;
        }

        #rideHistory {
            padding: 20px;
            background-color: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .ride-item {
            margin-bottom: 10px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 8px;
        }
    </style>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
</head>

<body>
    <div class="container" id="driverDashboard">
        <h2>Dashboard do Motorista</h2>
        <div class="map-container" id="map"></div>
        <button id="toggleOnline">Ficar Online</button>
    </div>
    <div class="container" id="rideHistory" style="display: none;">
        <h2>Histórico de Corridas</h2>
        <!-- Histórico de corridas será exibido aqui -->
    </div>
    <div class="bottom-nav">
        <button onclick="showDriverDashboard()">Motorista</button>
        <button onclick="showRideHistory()">Histórico de Corridas</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, getDocs, updateDoc, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBWzJvwwupeyVts_elKXG0a-ILTqP6Mvzg",
            authDomain: "markeplace-sj.firebaseapp.com",
            projectId: "markeplace-sj",
            storageBucket: "markeplace-sj.appspot.com",
            messagingSenderId: "942192953658",
            appId: "1:942192953658:web:8f07a84d2a9f56790fa803",
            measurementId: "G-C1710MDZ9F"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let isDriver = false;

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const userDoc = await getDoc(doc(db, "users", user.uid));
                if (userDoc.exists() && userDoc.data().role === 'driver') {
                    isDriver = true;
                    toggleOnlineButton.style.display = 'block';
                    loadRideHistory();
                } else {
                    isDriver = false;
                    toggleOnlineButton.style.display = 'none';
                }
            } else {
                isDriver = false;
                toggleOnlineButton.style.display = 'none';
            }
        });

        const toggleOnlineButton = document.getElementById('toggleOnline');
        toggleOnlineButton.addEventListener('click', () => {
            toggleOnlineStatus();
        });

        async function toggleOnlineStatus() {
            const user = auth.currentUser;
            if (user) {
                const userDocRef = doc(db, "users", user.uid);
                const userDoc = await getDoc(userDocRef);
                if (userDoc.exists()) {
                    const isOnline = userDoc.data().isOnline;
                    await updateDoc(userDocRef, {
                        isOnline: !isOnline
                    });
                    toggleOnlineButton.textContent = isOnline ? 'Ficar Online' : 'Ficar Offline';
                }
            }
        }

        function showDriverDashboard() {
            document.getElementById('driverDashboard').style.display = 'block';
            document.getElementById('rideHistory').style.display = 'none';
            initMap();
        }

        function showRideHistory() {
            document.getElementById('driverDashboard').style.display = 'none';
            document.getElementById('rideHistory').style.display = 'block';
            loadRideHistory();
        }

        async function loadRideHistory() {
            const user = auth.currentUser;
            if (user) {
                const ridesCollection = collection(db, "rides");
                const ridesSnapshot = await getDocs(ridesCollection);
                const ridesList = document.getElementById('rideHistory');
                ridesList.innerHTML = '<h2>Histórico de Corridas</h2>';
                ridesSnapshot.forEach((doc) => {
                    const ride = doc.data();
                    if (ride.driverId === user.uid) {
                        const rideElement = document.createElement('div');
                        rideElement.className = 'ride-item';
                        rideElement.innerHTML = `<p>Corrida de ${ride.startLocation} para ${ride.endLocation} - ${ride.date}</p>`;
                        ridesList.appendChild(rideElement);
                    }
                });
            }
        }

        function initMap() {
            const map = L.map('map').setView([-23.55052, -46.633308], 12);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition((position) => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    map.setView([lat, lng], 15);
                    L.marker([lat, lng]).addTo(map)
                        .bindPopup('Você está aqui')
                        .openPopup();
                });
            } else {
                alert("Seu navegador não suporta geolocalização.");
            }
        }

        document.addEventListener('DOMContentLoaded', (event) => {
            initMap();
        });
    </script>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
</body>

</html>